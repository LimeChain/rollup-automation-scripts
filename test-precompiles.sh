#!/bin/bash

# Load .env file
set -a && source .env && set +a

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Function to test precompile and assert response
test_precompile() {
    local name=$1
    local address=$2
    local input=$3
    local expected=$4

    echo "Testing $name ($address)..."

    # Make the call
    result=$(cast call $address $input --rpc-url $RPC_URL --block $BLOCK_NUMBER)

    # Compare with expected result
    if [ "$result" = "$expected" ]; then
        echo -e "${GREEN}✓ $name test passed${NC}"
        echo "  Expected: $expected"
        echo "  Got:      $result"
    else
        echo -e "${RED}✗ $name test failed${NC}"
        echo "  Expected: $expected"
        echo "  Got:      $result"
    fi
    echo "----------------------------------------"
}

# ECRECOVER (0x01)
ec_input="0x456e9aea5e197a1f1af7a3e85a3212fa4049a3ba34c2289b4c860fc0b0c64ef3000000000000000000000000000000000000000000000000000000000000001c9242685bf161793cc25603c231bc2f568eb630ea16aa137d2664ac80388256084f8ae3bd7535248d0bd448298cc2e2071e56992d0774dc340c368ae950852ada"
ec_expected="0x0000000000000000000000007156526fbd7a3c72969b54f64e42c10fbb768c8a"
test_precompile "ECRECOVER" "0x0000000000000000000000000000000000000001" "$ec_input" "$ec_expected"

# SHA256 (0x02)
sha_input="0x68656c6c6f"
sha_expected="0x2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824"
test_precompile "SHA256" "0x0000000000000000000000000000000000000002" "$sha_input" "$sha_expected"

# RIPEMD160 (0x03)
rmd_input="0xff"
rmd_expected="0x0000000000000000000000002c0c45d3ecab80fe060e5f1d7057cd2f8de5e557"
test_precompile "RIPEMD160" "0x0000000000000000000000000000000000000003" "$rmd_input" "$rmd_expected"

# IDENTITY (0x04)
id_input="0x68656c6c6f"
id_expected="0x68656c6c6f"
test_precompile "IDENTITY" "0x0000000000000000000000000000000000000004" "$id_input" "$id_expected"

# MODEXP (0x05)
modexp_input="0x00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000108090a0000000000000000000000000000000000000000000000000000000000"
modexp_expected="0x08"
test_precompile "MODEXP" "0x0000000000000000000000000000000000000005" "$modexp_input" "$modexp_expected"

# ECADD (0x06)
ecadd_input="0x0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002"
ecadd_expected="0x030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd315ed738c0e0a7c92e7845f96b2ae9c0a68a6a449e3538fc7ff3ebf7a5a18a2c4"
test_precompile "ECADD" "0x0000000000000000000000000000000000000006" "$ecadd_input" "$ecadd_expected"

# ECMUL (0x07)
ecmul_input="0x000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002"
ecmul_expected="0x030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd315ed738c0e0a7c92e7845f96b2ae9c0a68a6a449e3538fc7ff3ebf7a5a18a2c4"
test_precompile "ECMUL" "0x0000000000000000000000000000000000000007" "$ecmul_input" "$ecmul_expected"

# ECPAIRING (0x08)
ecpairing_input="0x1c76476f4def4bb94541d57ebba1193381ffa7aa76ada664dd31c16024c43f593034dd2920f673e204fee2811c678745fc819b55d3e9d294e45c9b03a76aef41209dd15ebff5d46c4bd888e51a93cf99a7329636c63514396b4a452003a35bf704bf11ca01483bfa8b34b43561848d28905960114c8ac04049af4b6315a416782bb8324af6cfc93537a2ad1a445cfd0ca2a71acd7ac41fadbf933c2a51be344d120a2a4cf30c1bf9845f20c6fe39e07ea2cce61f0c9bb048165fe5e4de877550111e129f1cf1097710d41c4ac70fcdfa5ba2023c6ff1cbeac322de49d1b6df7c2032c61a830e3c17286de9462bf242fca2883585b93870a73853face6a6bf411198e9393920d483a7260bfb731fb5d25f1aa493335a9e71297e485b7aef312c21800deef121f1e76426a00665e5c4479674322d4f75edadd46debd5cd992f6ed090689d0585ff075ec9e99ad690c3395bc4b313370b38ef355acdadcd122975b12c85ea5db8c6deb4aab71808dcb408fe3d1e7690c43d37b4ce6cc0166fa7daa"
ecpairing_expected="0x0000000000000000000000000000000000000000000000000000000000000001"
test_precompile "ECPAIRING" "0x0000000000000000000000000000000000000008" "$ecpairing_input" "$ecpairing_expected"

# BLAKE2F (0x09)
blake2f_input="0x0000000c48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001"
blake2f_expected="0xba80a53f981c4d0d6a2797b69f12f6e94c212f14685ac4b74b12bb6fdbffa2d17d87c5392aab792dc252d5de4533cc9518d38aa8dbf1925ab92386edd4009923"
test_precompile "BLAKE2F" "0x0000000000000000000000000000000000000009" "$blake2f_input" "$blake2f_expected"

# POINTEVALUATION (0x0A)
point_eval_input="0x01524aa8df452d888b115a905863db8bae91b5417cdeebeaf1552df90500e83b00000000000000000000000000000000a9dd5d0c6d576bd2e00ba4d52e7c3b0e124ea1e7d0b76d89fac4c76be11d9efb4b8bb7dba1c6494fff4f826e37f6874fb4debb2ef2639f217954edec33b49b0f80137f6dfcb34a4b0ebd02fda4873cb968ad6bed0455dce478ff77e893b6aa49a6e029a74c5297935ad7f05e88986ee8c6e9aaf47ad62672a5985df3d646d4995fcd197f529e86288d0bf63aaf8e0d32"
point_eval_expected="0x000000000000000000000000000000000000000000000000000000000000100073eda753299d7d483339d80809a1d80553bda402fffe5bfeffffffff00000001"
test_precompile "POINTEVALUATION" "0x000000000000000000000000000000000000000A" "$point_eval_input" "$point_eval_expected"

# BLS12_G1ADD (0x0B)
point_eval_input="0x0000000000000000000000000000000017f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb0000000000000000000000000000000008b3f481e3aaa0f1a09e30ed741d8ae4fcf5e095d5d00af600db18cb2c04b3edd03cc744a2888ae40caa232946c5e7e100000000000000000000000000000000112b98340eee2777cc3c14163dea3ec97977ac3dc5c70da32e6e87578f44912e902ccef9efe28d4a78b8999dfbca942600000000000000000000000000000000186b28d92356c4dfec4b5201ad099dbdede3781f8998ddf929b4cd7756192185ca7b8f4ef7088f813270ac3d48868a21"
point_eval_expected="0x000000000000000000000000000000000a40300ce2dec9888b60690e9a41d3004fda4886854573974fab73b046d3147ba5b7a5bde85279ffede1b45b3918d82d0000000000000000000000000000000006d3d887e9f53b9ec4eb6cedf5607226754b07c01ace7834f57f3e7315faefb739e59018e22c492006190fba4a870025"
test_precompile "BLS12_G1ADD" "0x000000000000000000000000000000000000000B" "$point_eval_input" "$point_eval_expected"

# BLS12_G1MSM (0x0C)
point_eval_input="0x0000000000000000000000000000000017f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb0000000000000000000000000000000008b3f481e3aaa0f1a09e30ed741d8ae4fcf5e095d5d00af600db18cb2c04b3edd03cc744a2888ae40caa232946c5e7e10000000000000000000000000000000000000000000000000000000000000002"
point_eval_expected="0x000000000000000000000000000000000572cbea904d67468808c8eb50a9450c9721db309128012543902d0ac358a62ae28f75bb8f1c7c42c39a8c5529bf0f4e00000000000000000000000000000000166a9d8cabc673a322fda673779d8e3822ba3ecb8670e461f73bb9021d5fd76a4c56d9d4cd16bd1bba86881979749d28"
test_precompile "BLS12_G1MSM" "0x000000000000000000000000000000000000000C" "$point_eval_input" "$point_eval_expected"

# BLS12_G2ADD (0x0D)
point_eval_input="0x00000000000000000000000000000000024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb80000000000000000000000000000000013e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e000000000000000000000000000000000ce5d527727d6e118cc9cdc6da2e351aadfd9baa8cbdd3a76d429a695160d12c923ac9cc3baca289e193548608b82801000000000000000000000000000000000606c4a02ea734cc32acd2b02bc28b99cb3e287e85a763af267492ab572e99ab3f370d275cec1da1aaa9075ff05f79be00000000000000000000000000000000103121a2ceaae586d240843a398967325f8eb5a93e8fea99b62b9f88d8556c80dd726a4b30e84a36eeabaf3592937f2700000000000000000000000000000000086b990f3da2aeac0a36143b7d7c824428215140db1bb859338764cb58458f081d92664f9053b50b3fbd2e4723121b68000000000000000000000000000000000f9e7ba9a86a8f7624aa2b42dcc8772e1af4ae115685e60abc2c9b90242167acef3d0be4050bf935eed7c3b6fc7ba77e000000000000000000000000000000000d22c3652d0dc6f0fc9316e14268477c2049ef772e852108d269d9c38dba1d4802e8dae479818184c08f9a569d878451"
point_eval_expected="0x000000000000000000000000000000000b54a8a7b08bd6827ed9a797de216b8c9057b3a9ca93e2f88e7f04f19accc42da90d883632b9ca4dc38d013f71ede4db00000000000000000000000000000000077eba4eecf0bd764dce8ed5f45040dd8f3b3427cb35230509482c14651713282946306247866dfe39a8e33016fcbe520000000000000000000000000000000014e60a76a29ef85cbd69f251b9f29147b67cfe3ed2823d3f9776b3a0efd2731941d47436dc6d2b58d9e65f8438bad073000000000000000000000000000000001586c3c910d95754fef7a732df78e279c3d37431c6a2b77e67a00c7c130a8fcd4d19f159cbeb997a178108fffffcbd20"
test_precompile "BLS12_G2ADD" "0x000000000000000000000000000000000000000D" "$point_eval_input" "$point_eval_expected"

# BLS12_G2MSM (0x0E)
point_eval_input="0x00000000000000000000000000000000024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb80000000000000000000000000000000013e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e000000000000000000000000000000000ce5d527727d6e118cc9cdc6da2e351aadfd9baa8cbdd3a76d429a695160d12c923ac9cc3baca289e193548608b82801000000000000000000000000000000000606c4a02ea734cc32acd2b02bc28b99cb3e287e85a763af267492ab572e99ab3f370d275cec1da1aaa9075ff05f79be0000000000000000000000000000000000000000000000000000000000000002"
point_eval_expected="0x000000000000000000000000000000001638533957d540a9d2370f17cc7ed5863bc0b995b8825e0ee1ea1e1e4d00dbae81f14b0bf3611b78c952aacab827a053000000000000000000000000000000000a4edef9c1ed7f729f520e47730a124fd70662a904ba1074728114d1031e1572c6c886f6b57ec72a6178288c47c33577000000000000000000000000000000000468fb440d82b0630aeb8dca2b5256789a66da69bf91009cbfe6bd221e47aa8ae88dece9764bf3bd999d95d71e4c9899000000000000000000000000000000000f6d4552fa65dd2638b361543f887136a43253d9c66c411697003f7a13c308f5422e1aa0a59c8967acdefd8b6e36ccf3"
test_precompile "BLS12_G2MSM" "0x000000000000000000000000000000000000000E" "$point_eval_input" "$point_eval_expected"

# BLS12_PAIRING_CHECK (0x0F)
point_eval_input="0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb80000000000000000000000000000000013e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e000000000000000000000000000000000ce5d527727d6e118cc9cdc6da2e351aadfd9baa8cbdd3a76d429a695160d12c923ac9cc3baca289e193548608b82801000000000000000000000000000000000606c4a02ea734cc32acd2b02bc28b99cb3e287e85a763af267492ab572e99ab3f370d275cec1da1aaa9075ff05f79be"
point_eval_expected="0x0000000000000000000000000000000000000000000000000000000000000001"
test_precompile "BLS12_PAIRING_CHECK" "0x000000000000000000000000000000000000000F" "$point_eval_input" "$point_eval_expected"

# BLS12_MAP_FP_TO_G1 (0x10)
point_eval_input="0x00000000000000000000000000000000156c8a6a2c184569d69a76be144b5cdc5141d2d2ca4fe341f011e25e3969c55ad9e9b9ce2eb833c81a908e5fa4ac5f03"
point_eval_expected="0x00000000000000000000000000000000184bb665c37ff561a89ec2122dd343f20e0f4cbcaec84e3c3052ea81d1834e192c426074b02ed3dca4e7676ce4ce48ba0000000000000000000000000000000004407b8d35af4dacc809927071fc0405218f1401a6d15af775810e4e460064bcc9468beeba82fdc751be70476c888bf3"
test_precompile "BLS12_MAP_FP_TO_G1" "0x0000000000000000000000000000000000000010" "$point_eval_input" "$point_eval_expected"

# BLS12_MAP_FP2_TO_G2 (0x10)
point_eval_input="0x0000000000000000000000000000000007355d25caf6e7f2f0cb2812ca0e513bd026ed09dda65b177500fa31714e09ea0ded3a078b526bed3307f804d4b93b040000000000000000000000000000000002829ce3c021339ccb5caf3e187f6370e1e2a311dec9b75363117063ab2015603ff52c3d3b98f19c2f65575e99e8b78c"
point_eval_expected="0x0000000000000000000000000000000000e7f4568a82b4b7dc1f14c6aaa055edf51502319c723c4dc2688c7fe5944c213f510328082396515734b6612c4e7bb700000000000000000000000000000000126b855e9e69b1f691f816e48ac6977664d24d99f8724868a184186469ddfd4617367e94527d4b74fc86413483afb35b000000000000000000000000000000000caead0fd7b6176c01436833c79d305c78be307da5f6af6c133c47311def6ff1e0babf57a0fb5539fce7ee12407b0a42000000000000000000000000000000001498aadcf7ae2b345243e281ae076df6de84455d766ab6fcdaad71fab60abb2e8b980a440043cd305db09d283c895e3d"
test_precompile "BLS12_MAP_FP2_TO_G2" "0x0000000000000000000000000000000000000011" "$point_eval_input" "$point_eval_expected"

# P256VERIFY (0x100)
p256_input="0x307bfaaffb650c889c84bf83f0300e5dc87e000000008408fd5f64b582e3bb14f612820687604fa01906066a378d67540982e29575d019aabe90924ead5c860d3f9367702dd7dd4f75ea98afd20e328a1a99f4857b316525328230ce294b0fef2927b10512bae3eddcfe467828128bad2903269919f7086069c8c4df6c732838c7787964eaac00e5921fb1498a60f4606766b3d9685001558d1a974e7341513e"
p256_expected="0x0000000000000000000000000000000000000000000000000000000000000001"
test_precompile "P256VERIFY" "0x0000000000000000000000000000000000000100" "$p256_input" "$p256_expected"
